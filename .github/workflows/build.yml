name: CI

on: [push]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build-type: [debug]

        include:

        - os: ubuntu-latest
          build-type: debug
          toolchain: {compiler: gcc, version: '12', mkl_version: '2024.1', build: fpm}

    defaults:
      run:
        shell: bash

    steps:
      - name: Install LAPACK (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y liblapack-dev

      - name: Intel Apt repository
        timeout-minutes: 1
        run: |
          wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
          sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
          rm GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
          echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
          sudo apt-get update
          
      - name: Install Intel oneAPI compilers
        timeout-minutes: 5
        run: sudo apt-get install intel-oneapi-compiler-fortran intel-oneapi-compiler-dpcpp-cpp 

      # optional
      - name: Install Intel MPI and MKL
        timeout-minutes: 5
        run: |
          sudo apt-get install intel-oneapi-mpi intel-oneapi-mpi-devel intel-oneapi-mkl intel-oneapi-mkl-devel
          echo "MKL root:"
          find /opt/intel/oneapi/mkl -maxdepth 2
          echo "Searching for mkl.h:"
          find /opt/intel/oneapi/mkl -name mkl.h

      - name: Setup Intel oneAPI environment
        run: |
          source /opt/intel/oneapi/setvars.sh
          printenv >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install fpm
        uses: fortran-lang/setup-fpm@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GCC Compiler
        uses: fortran-lang/setup-fortran@v1
        with:
          compiler: ${{ matrix.toolchain.compiler }}
          version: ${{ matrix.toolchain.version }}

      - name: Setup environment for Fortran and C compilers
        run: |
            FC="gfortran"
            CC="gcc"
            CXX="g++"
            echo "FC=$FC" >> $GITHUB_ENV
            echo "CC=$CC" >> $GITHUB_ENV
            echo "CXX=$CXX" >> $GITHUB_ENV

      - name: Build library (fpm)
        run: |
          export LD_LIBRARY_PATH=/opt/intel/oneapi/mkl/latest/lib/intel64:$LD_LIBRARY_PATH
          export LIBRARY_PATH=/opt/intel/oneapi/mkl/latest/lib/intel64:$LIBRARY_PATH
          export FPM_CXXFLAGS=-DW_MKL
          export CPATH=/opt/intel/oneapi/mkl/latest/include:$CPATH
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$LIBRARY_PATH" >> $GITHUB_ENV
          echo "FPM_CXXFLAGS=$FPM_CXXFLAGS" >> $GITHUB_ENV
          echo "CPATH=$CPATH" >> $GITHUB_ENV
          fpm --version
          fpm build

      - name: Run unit tests (fpm)
        run: fpm test